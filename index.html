<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Toolbox: Preset & Worldbook</title>
<!-- 引入 JSZip 和 JSON5 库 -->
<script src="https://cdn.jsdelivr.net/npm/json5@2/dist/index.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3/dist/jszip.min.js"></script>

<style>
  :root {
    --bg-color: #fafafa;
    --card-bg: #ffffff;
    --text-main: #262626;
    --text-sub: #8e8e8e;
    --border: #efefef;
    --btn-border: #d9d9d9; /* 按钮边框色 */
    --btn-black: #262626;
    --btn-text: #ffffff;
    --highlight-bg: #f7f7f7;
    --select-bg: #e0e0e0;
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    background-color: var(--bg-color);
    color: var(--text-main);
    margin: 0;
    padding: 20px 16px;
    line-height: 1.5;
  }

  h1 {
    font-size: 1.1rem;
    font-weight: 600;
    text-align: center;
    margin-bottom: 24px;
    letter-spacing: 1px;
    text-transform: uppercase;
    color: var(--text-main);
  }

  /* 上传区域 */
  .upload-container {
    text-align: center;
    margin-bottom: 16px;
  }

  input[type="file"] { display: none; }

  .custom-file-upload {
    display: inline-block;
    padding: 10px 20px;
    border: 1px solid var(--text-main);
    border-radius: 4px;
    cursor: pointer;
    background: transparent;
    font-size: 0.9rem;
    font-weight: 500;
    transition: all 0.2s ease;
  }

  .custom-file-upload:active {
    background: var(--text-main);
    color: var(--btn-text);
  }

  /* 工具栏区域 */
  .toolbar-wrapper {
    max-width: 600px;
    margin: 0 auto 20px auto;
    display: none;
  }

  .search-box {
    width: 100%;
    position: relative;
    display: flex;
    align-items: center;
    margin-bottom: 12px;
  }

  .search-icon {
    position: absolute;
    left: 12px;
    width: 16px;
    height: 16px;
    fill: var(--text-sub);
    pointer-events: none;
  }

  #searchInput {
    width: 100%;
    padding: 10px 10px 10px 36px;
    border: 1px solid var(--border);
    border-radius: 4px;
    background: var(--card-bg);
    color: var(--text-main);
    font-size: 0.9rem;
    outline: none;
    transition: border-color 0.2s;
    -webkit-appearance: none;
  }

  #searchInput:focus {
    border-color: var(--text-sub);
  }

  /* 多选操作栏 */
  .selection-controls {
    display: flex;
    gap: 10px; /* 按钮间距 */
    justify-content: space-between;
  }
  
  /* 统一按钮样式：白底黑字带边框 */
  .ctrl-btn {
    flex: 1; /* 平分宽度，确保大小一致 */
    padding: 10px;
    font-size: 0.85rem;
    font-weight: 500;
    background: #fff;
    border: 1px solid var(--btn-border);
    border-radius: 4px;
    color: var(--text-main);
    cursor: pointer;
    text-align: center;
    transition: all 0.2s;
  }
  
  .ctrl-btn:active { 
    background: #f5f5f5; 
    border-color: var(--text-main);
  }

  /* 下载按钮默认隐藏 */
  #downloadSelectedBtn {
    display: none;
    /* 稍微加深边框以示区别，但保持风格统一 */
    border-color: #999;
  }

  #status-log {
    font-size: 0.8rem;
    color: var(--text-sub);
    text-align: center;
    margin-bottom: 24px;
    min-height: 1.2rem;
  }

  /* 列表区域 */
  #entries {
    max-width: 600px;
    margin: 0 auto;
    padding-bottom: 80px;
  }

  .entry {
    background: var(--card-bg);
    border-bottom: 1px solid var(--border);
    transition: background 0.2s, border 0.2s;
    position: relative;
  }
  .entry:first-child { border-top: 1px solid var(--border); }

  /* 状态样式 */
  .entry.highlight {
    border-left: 4px solid var(--text-main);
    background-color: var(--highlight-bg);
  }
  
  .entry.selected {
    background-color: var(--select-bg) !important;
  }

  .entry-header {
    padding: 16px 12px;
    display: flex;
    align-items: center;
    cursor: pointer;
    user-select: none;
  }
  .entry-header:active { background-color: #eaeaea; }

  /* 复选框样式 */
  .checkbox-custom {
    display: none;
    width: 20px;
    height: 20px;
    margin-right: 12px;
    cursor: pointer;
    accent-color: var(--text-main);
  }

  .selection-mode .checkbox-custom {
    display: block;
  }
  
  .selection-mode .export-btn {
    display: none;
  }

  .entry-title {
    font-weight: 500;
    font-size: 0.95rem;
    margin-right: 12px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    flex: 1;
  }

  .entry.highlight .entry-title { font-weight: 600; }

  .export-btn {
    padding: 6px 12px;
    font-size: 0.8rem;
    background: white;
    color: var(--text-main);
    border: 1px solid #ddd;
    border-radius: 4px;
    cursor: pointer;
    flex-shrink: 0;
  }
  
  .entry-content {
    display: none;
    padding: 0 12px 20px 12px;
    font-size: 0.9rem;
    color: #555;
    white-space: pre-wrap;
    word-break: break-word;
    line-height: 1.6;
    border-top: 1px dashed #eee;
  }

  .entry.expanded .entry-content { display: block; animation: fadeIn 0.3s ease; }
  
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-5px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* 模态框 (Modal) 样式 */
  .modal-overlay {
    display: none;
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(2px);
    z-index: 100;
    justify-content: center;
    align-items: center;
  }
  .modal-box {
    background: white;
    padding: 24px;
    border-radius: 8px;
    width: 85%;
    max-width: 320px;
    text-align: center;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }
  .modal-title {
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 20px;
    color: var(--text-main);
  }
  .modal-actions {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  .modal-btn {
    padding: 12px;
    border-radius: 4px;
    font-size: 0.95rem;
    cursor: pointer;
    border: none;
    width: 100%;
  }
  .btn-primary { background: var(--btn-black); color: white; }
  .btn-secondary { background: #f0f0f0; color: var(--text-main); }
  .btn-close { margin-top: 10px; background: transparent; color: var(--text-sub); font-size: 0.85rem; padding: 8px; }

</style>
</head>
<body>

<h1>Text Exporter</h1>

<div class="upload-container">
  <label for="jsonFile" class="custom-file-upload">
    OPEN JSON
  </label>
  <input type="file" id="jsonFile" accept=".json" />
</div>

<!-- 工具栏 -->
<div class="toolbar-wrapper" id="toolbarWrapper">
  <!-- 搜索栏 -->
  <div class="search-box">
    <svg class="search-icon" viewBox="0 0 24 24">
      <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
    </svg>
    <input type="text" id="searchInput" placeholder="搜索条目..." autocomplete="off">
  </div>
  
  <!-- 多选控制按钮 (平分宽度，统一样式) -->
  <div class="selection-controls">
    <button id="toggleSelectBtn" class="ctrl-btn">多选</button>
    <button id="downloadSelectedBtn" class="ctrl-btn">下载选中</button>
  </div>
</div>

<div id="status-log">等待导入...</div>
<div id="entries"></div>

<!-- 模态框：Worldbook 操作选择 -->
<div id="choiceModal" class="modal-overlay">
  <div class="modal-box">
    <div class="modal-title" id="modalTitle">检测到 Worldbook</div>
    <div class="modal-actions">
      <!-- 修改文案：去掉了 (全部) -->
      <button class="modal-btn btn-primary" id="btnZip">打包下载 ZIP</button>
      <button class="modal-btn btn-secondary" id="btnList">查看条目列表</button>
      <button class="modal-btn btn-close" id="btnClose">取消</button>
    </div>
  </div>
</div>

<script>
// --- 全局变量 ---
let currentWorldbookData = null;
let currentBookName = '';
let globalItemList = []; // 所有条目
let currentDisplayList = []; // 当前筛选后显示的条目
let isSelectionMode = false;
let selectedIndices = new Set(); // 存储被选中的 item._originalIndex

// --- 工具函数 ---
function sanitizeFilename(name) {
  return (name || 'unnamed').replace(/[\\/:*?"<>|]/g, '_');
}

function log(msg) {
  document.getElementById('status-log').textContent = msg;
}

// 导出单个文本
function exportToTxt(name, content) {
  const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = sanitizeFilename(name) + '.txt';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

// 模态框控制
const modal = document.getElementById('choiceModal');
const closeModal = () => { 
  modal.style.display = 'none'; 
  document.getElementById('jsonFile').value = ''; 
};
document.getElementById('btnClose').addEventListener('click', closeModal);

// --- 重置状态 ---
function resetState() {
  document.getElementById('entries').innerHTML = ''; 
  document.getElementById('toolbarWrapper').style.display = 'none';
  document.getElementById('searchInput').value = '';
  
  isSelectionMode = false;
  selectedIndices.clear();
  updateSelectionUI();
}

// --- 主逻辑：文件上传 ---
document.getElementById('jsonFile').addEventListener('change', async function(e) {
  const file = e.target.files[0];
  if (!file) return;

  log('正在读取...');
  resetState();
  
  const text = await file.text();
  let data;
  try {
    data = JSON5.parse(text);
  } catch (err) {
    alert('JSON 解析失败');
    log('解析错误');
    return;
  }

  // 1. Worldbook 检测
  if (data.entries && typeof data.entries === 'object' && !Array.isArray(data.entries)) {
    currentWorldbookData = data;
    currentBookName = data.book?.name || data.name || file.name.replace(/\.json$/i, '');
    currentBookName = sanitizeFilename(currentBookName);
    
    document.getElementById('modalTitle').textContent = `检测到: ${currentBookName}`;
    modal.style.display = 'flex'; 
    log('等待选择操作...');
    return;
  }

  // 2. Preset 检测
  const presetEntries = data.presets?.[0]?.prompts || data.prompts || [];
  if (Array.isArray(presetEntries) && presetEntries.length > 0) {
    currentBookName = data.presets?.[0]?.name || file.name.replace(/\.json$/i, '');
    currentBookName = sanitizeFilename(currentBookName);

    log(`加载预设条目: ${presetEntries.length}个`);
    globalItemList = presetEntries.map((item, index) => ({
      name: item.name || item.title || item.comment || `Preset_${index}`,
      content: item.content || '',
      _originalIndex: index
    }));
    
    currentDisplayList = [...globalItemList];
    renderList(currentDisplayList);
    document.getElementById('toolbarWrapper').style.display = 'block';
    return;
  }

  log('无法识别的文件格式');
  alert('未找到有效的 entries 或 prompts');
});

// --- 搜索功能 ---
document.getElementById('searchInput').addEventListener('input', function(e) {
  const keyword = e.target.value.toLowerCase().trim();

  if (!globalItemList || globalItemList.length === 0) return;

  if (!keyword) {
    const resetList = globalItemList.map(item => ({ ...item, _highlight: false }));
    currentDisplayList = resetList;
    renderList(currentDisplayList);
    return;
  }

  const matched = [];
  const others = [];

  globalItemList.forEach(item => {
    const title = (item.name || '').toLowerCase();
    const content = (item.content || '').toLowerCase();
    const displayItem = { ...item };

    if (title.includes(keyword) || content.includes(keyword)) {
      displayItem._highlight = true;
      matched.push(displayItem);
    } else {
      displayItem._highlight = false;
      others.push(displayItem);
    }
  });

  currentDisplayList = [...matched, ...others];
  renderList(currentDisplayList);
});

// --- 多选功能逻辑 ---

const toggleBtn = document.getElementById('toggleSelectBtn');
const downloadSelectedBtn = document.getElementById('downloadSelectedBtn');
const entriesContainer = document.getElementById('entries');

toggleBtn.addEventListener('click', () => {
  isSelectionMode = !isSelectionMode;
  updateSelectionUI();
  renderList(currentDisplayList); 
});

function updateSelectionUI() {
  if (isSelectionMode) {
    toggleBtn.textContent = '退出多选';
    downloadSelectedBtn.style.display = 'block';
    entriesContainer.classList.add('selection-mode');
  } else {
    toggleBtn.textContent = '多选';
    downloadSelectedBtn.style.display = 'none';
    entriesContainer.classList.remove('selection-mode');
    
    selectedIndices.clear();
    updateDownloadBtn();
  }
}

function updateDownloadBtn() {
  const count = selectedIndices.size;
  downloadSelectedBtn.textContent = `下载选中 (${count})`;
}

// 下载选中项
downloadSelectedBtn.addEventListener('click', async () => {
  if (selectedIndices.size === 0) {
    alert('请至少选择一个条目');
    return;
  }

  log('正在打包选中项...');
  const zip = new JSZip();
  let count = 0;

  globalItemList.forEach(item => {
    if (selectedIndices.has(item._originalIndex)) {
      const content = (item.content || '').trim();
      const filename = sanitizeFilename(item.name);
      let finalName = filename + '.txt';
      if (zip.file(finalName)) {
        finalName = `${filename}_${item._originalIndex}.txt`;
      }
      
      zip.file(finalName, content);
      count++;
    }
  });

  const blob = await zip.generateAsync({ type: 'blob' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${currentBookName}.zip`; 
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);

  log(`已下载选中项 (${count}条)`);
});

// --- Worldbook 操作 ---

// A: 全部下载
document.getElementById('btnZip').addEventListener('click', async () => {
  modal.style.display = 'none';
  log('正在打包 ZIP...');
  
  const entriesObj = currentWorldbookData.entries;
  const zip = new JSZip();
  let count = 0;

  for (const key in entriesObj) {
    const entry = entriesObj[key];
    const content = (entry.content ?? '').trim();
    if (!content) continue;

    const title = entry.comment || entry.title || entry.name || `entry_${key}`;
    zip.file(sanitizeFilename(title) + '.txt', content);
    count++;
  }

  if (count === 0) {
    alert('没有有效内容可导出'); return;
  }

  const blob = await zip.generateAsync({ type: 'blob' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${currentBookName}.zip`; 
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
  
  log(`已下载 ZIP (${count}条)`);
});

// B: 查看列表
document.getElementById('btnList').addEventListener('click', () => {
  modal.style.display = 'none';
  log('正在渲染列表...');

  const entriesObj = currentWorldbookData.entries;
  const listData = [];
  let idx = 0;
  
  for (const key in entriesObj) {
    const entry = entriesObj[key];
    const content = (entry.content ?? '').trim();
    if (!content) continue; 

    const title = entry.comment || entry.title || entry.name || `entry_${key}`;
    
    listData.push({
      name: title,
      content: content,
      _originalIndex: idx++ 
    });
  }

  globalItemList = listData;
  currentDisplayList = [...globalItemList];
  
  renderList(currentDisplayList);
  document.getElementById('toolbarWrapper').style.display = 'block'; 
});


// --- 核心渲染函数 ---
function renderList(items) {
  const container = document.getElementById('entries');
  container.innerHTML = '';

  if (items.length === 0) {
    container.innerHTML = '<div style="text-align:center;padding:20px;color:#999;">无数据</div>';
    return;
  }

  items.forEach(item => {
    const div = document.createElement('div');
    let className = 'entry';
    if (item._highlight) className += ' highlight';
    if (isSelectionMode && selectedIndices.has(item._originalIndex)) className += ' selected';
    
    div.className = className;

    // Header
    const header = document.createElement('div');
    header.className = 'entry-header';

    // 1. 复选框
    if (isSelectionMode) {
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.className = 'checkbox-custom';
      checkbox.checked = selectedIndices.has(item._originalIndex);
      
      checkbox.addEventListener('click', (e) => {
        e.stopPropagation(); 
        if (checkbox.checked) {
          selectedIndices.add(item._originalIndex);
          div.classList.add('selected');
        } else {
          selectedIndices.delete(item._originalIndex);
          div.classList.remove('selected');
        }
        updateDownloadBtn();
      });
      
      header.appendChild(checkbox);
    }

    // 2. 标题
    const title = document.createElement('div');
    title.className = 'entry-title';
    title.textContent = item.name || 'Unnamed';
    header.appendChild(title);
    
    // 3. 导出按钮
    const exportBtn = document.createElement('button');
    exportBtn.className = 'export-btn';
    exportBtn.textContent = '导出';
    exportBtn.addEventListener('click', (e) => {
      e.stopPropagation(); 
      exportToTxt(item.name, item.content || '');
    });
    header.appendChild(exportBtn);

    // Content
    const contentDiv = document.createElement('div');
    contentDiv.className = 'entry-content';
    contentDiv.textContent = item.content || '';

    // Header 展开事件
    header.addEventListener('click', (e) => {
      div.classList.toggle('expanded');
    });

    div.appendChild(header);
    div.appendChild(contentDiv);
    container.appendChild(div);
  });
}

</script>
</body>
</html>